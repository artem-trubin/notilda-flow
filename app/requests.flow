import net/http;

import app/note;

export {
  getNotes(onNotesLoaded : ([Note]) -> void) -> void;
  saveNote(onNoteSaved : (string) -> void) -> void;
}

apiUrl = "http://localhost:3001";
notesEndpoint = "/api/notes";

getNotes(onNotesLoaded : ([Note]) -> void) -> void {
  onLoad = \data -> {
    dataJson = parseJson(data);
    notesJson = getJsonArrayValue(dataJson, []);
    onNotesLoaded(map(notesJson, json2Note));
  }

  onError = \err -> {
    println("An unexpected error occured.");
    println(err);
  }

  httpRequest(
    apiUrl + notesEndpoint,
    false,
    [
      KeyValue("Content-Type", "application/json")
    ],
    [],
    onLoad,
    onError,
    nop1,
  );
}

// saveNote(onNoteSaved : (string) -> void) -> void {
//   println("We are here");
//   httpRequest(
//     apiUrl + notesEndpoint + "/test",
//     true,
//     [
//       KeyValue("Content-Type", "application/json")
//     ],
//     [
//       KeyValue("Test", "another test")
//     ],
//     onNoteSaved,
//     nop1,
//     nop1,
//   )
// }

// httpCustomRequest(
// 		url : string,
// 		method : RequestMethod,
// 		headers : [KeyValue],
// 		data : RequestData,
// 		onResponse : (responseStatus : int, responseData : string, responseHeaders : [KeyValue]) -> void,
// 		async : bool
// 	) -> void;

saveNote(onNoteSaved : (string) -> void) -> void {
  println("We are here");
  httpCustomRequest(
    apiUrl + notesEndpoint + "/test",
    POST(),
    [
      KeyValue("Content-Type", "application/json")
    ],
    RequestPayload(json2string(JsonObject([Pair("testProperty", JsonString("Test value"))]))),
    \status, data, headers -> {
      println("this is status");
      println(status);
      println("This is data");
      println(data);
      println("this is headers");
      println(headers);
    },
    false
  )
}
